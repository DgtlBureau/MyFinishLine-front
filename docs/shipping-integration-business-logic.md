# Бизнес-логика интеграции службы доставки DHL

## Содержание
1. [Обзор системы](#1-обзор-системы)
2. [Бизнес-требования](#2-бизнес-требования)
3. [User Journey](#3-user-journey)
4. [Детальные flow-диаграммы](#4-детальные-flow-диаграммы)
5. [Зоны доставки и ценообразование](#5-зоны-доставки-и-ценообразование)
6. [Взаимодействие систем](#6-взаимодействие-систем)
7. [Сценарии и Edge Cases](#7-сценарии-и-edge-cases)
8. [Статусы и уведомления](#8-статусы-и-уведомления)

---

## 1. Обзор системы

### 1.1 Текущее состояние

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ТЕКУЩИЙ ПРОЦЕСС (AS-IS)                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   [Пользователь] ──► [Выбор челленджа] ──► [Оплата Stripe] ──► [Готово] │
│                                                                         │
│   • Цена показывается БЕЗ доставки                                      │
│   • Доставка = 0 в Order Summary                                        │
│   • Регион не учитывается при покупке                                   │
│   • Адрес собирается только при Redemption                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 Целевое состояние

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ЦЕЛЕВОЙ ПРОЦЕСС (TO-BE)                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   [Пользователь]                                                        │
│        │                                                                │
│        ▼                                                                │
│   [Выбор челленджа]                                                     │
│        │                                                                │
│        ▼                                                                │
│   [Выбор РЕГИОНА ДОСТАВКИ] ◄─── Пользователь САМ выбирает страну        │
│        │                        (не автоопределение по IP/VPN)          │
│        ▼                                                                │
│   [Расчет стоимости]                                                    │
│        │                                                                │
│        ▼                                                                │
│   [Показ ИТОГОВОЙ ЦЕНЫ] ◄─── Медаль + Доставка = Итого                  │
│        │                                                                │
│        ▼                                                                │
│   [Оплата Stripe] ──► Оплачивается ВСЯ сумма включая доставку           │
│        │                                                                │
│        ▼                                                                │
│   [Прохождение челленджа]                                               │
│        │                                                                │
│        ▼                                                                │
│   [Redemption - ввод ТОЧНОГО адреса]                                    │
│        │                                                                │
│        ▼                                                                │
│   [Создание отправления DHL]                                            │
│        │                                                                │
│        ▼                                                                │
│   [Отслеживание доставки]                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Бизнес-требования

### 2.1 Ключевые требования

| # | Требование | Решение |
|---|------------|---------|
| BR-1 | Показывать полную стоимость (медаль + доставка) ДО оплаты | Пользователь выбирает регион → система рассчитывает доставку |
| BR-2 | Стоимость доставки зависит от региона | Зонная система ценообразования (4 зоны) |
| BR-3 | Не полагаться на автоопределение региона (VPN) | Пользователь ЯВНО выбирает страну доставки |
| BR-4 | Заказ награды происходит ПОСЛЕ покупки | Двухэтапный процесс: Покупка → Redemption |
| BR-5 | Отслеживание статуса доставки | Интеграция с DHL Tracking API |

### 2.2 Бизнес-правила

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          БИЗНЕС-ПРАВИЛА                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ПРАВИЛО 1: Выбор региона                                               │
│  ─────────────────────────                                              │
│  • Регион выбирается пользователем вручную                              │
│  • Система НЕ определяет регион по IP                                   │
│  • Выбранный регион сохраняется в заказе                                │
│  • При Redemption страна должна совпадать с выбранным регионом          │
│                                                                         │
│  ПРАВИЛО 2: Изменение региона                                           │
│  ────────────────────────────                                           │
│  • ДО оплаты: можно менять свободно                                     │
│  • ПОСЛЕ оплаты: изменение требует доплаты/возврата разницы             │
│  • Рекомендация: блокировать изменение после оплаты                     │
│                                                                         │
│  ПРАВИЛО 3: Валидация адреса                                            │
│  ───────────────────────────                                            │
│  • Страна в адресе должна входить в оплаченную зону                     │
│  • При несовпадении - уведомить пользователя                            │
│  • Предложить: доплатить разницу ИЛИ изменить адрес                     │
│                                                                         │
│  ПРАВИЛО 4: Сроки Redemption                                            │
│  ──────────────────────────                                             │
│  • Redemption доступен в течение 12 месяцев после завершения челленджа  │
│  • После истечения срока - награда аннулируется                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. User Journey

### 3.1 Полный путь пользователя

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                           USER JOURNEY MAP                                 ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  ЭТАП 1: ВЫБОР И ПОКУПКА                                                  ║
║  ════════════════════════                                                 ║
║                                                                           ║
║  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ ║
║  │  Лендинг    │───►│   Выбор     │───►│   Выбор     │───►│   Обзор     │ ║
║  │  страница   │    │  челленджа  │    │   региона   │    │   заказа    │ ║
║  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘ ║
║        │                  │                  │                  │         ║
║        ▼                  ▼                  ▼                  ▼         ║
║   "Amazonia        "42 km за          "Куда доставить    "Медаль: $49    ║
║    Quest"           30 дней"           медаль?"           Доставка: $15  ║
║                                                            ─────────────  ║
║                                        [Германия ▼]        Итого: $64"   ║
║                                                                           ║
║                                                                           ║
║  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                    ║
║  │   Ввод      │───►│   Оплата    │───►│   Успех!    │                    ║
║  │   данных    │    │   Stripe    │    │             │                    ║
║  └─────────────┘    └─────────────┘    └─────────────┘                    ║
║        │                  │                  │                            ║
║        ▼                  ▼                  ▼                            ║
║   "Имя, Email,      Stripe           "Спасибо!                           ║
║    Промокод"        Checkout          Начните челлендж"                  ║
║                                                                           ║
║                                                                           ║
║  ЭТАП 2: ПРОХОЖДЕНИЕ ЧЕЛЛЕНДЖА                                            ║
║  ══════════════════════════════                                           ║
║                                                                           ║
║  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ ║
║  │  Подключение│───►│  Активности │───►│  Прогресс   │───►│  Завершение │ ║
║  │  Strava     │    │  (бег и тд) │    │  на карте   │    │  челленджа  │ ║
║  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘ ║
║                                                                           ║
║                                                                           ║
║  ЭТАП 3: ПОЛУЧЕНИЕ НАГРАДЫ (REDEMPTION)                                   ║
║  ═══════════════════════════════════════                                  ║
║                                                                           ║
║  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ ║
║  │   Уведом-   │───►│   Ввод      │───►│  Подтверж-  │───►│  Отправка   │ ║
║  │   ление     │    │   адреса    │    │   дение     │    │   DHL       │ ║
║  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘ ║
║        │                  │                  │                  │         ║
║        ▼                  ▼                  ▼                  ▼         ║
║   "Поздравляем!    Полный адрес      "Проверьте        Создание          ║
║    Заберите        доставки в        данные"           shipment          ║
║    медаль!"        пределах                            в DHL             ║
║                    оплаченной зоны                                       ║
║                                                                           ║
║                                                                           ║
║  ЭТАП 4: ДОСТАВКА                                                         ║
║  ════════════════                                                         ║
║                                                                           ║
║  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ ║
║  │  Tracking   │───►│  В пути     │───►│  Прибыла    │───►│  Получена   │ ║
║  │  номер      │    │             │    │  в пункт    │    │             │ ║
║  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘ ║
║        │                  │                  │                  │         ║
║        ▼                  ▼                  ▼                  ▼         ║
║   Email с          Push/Email        Push/Email         "Оцените         ║
║   tracking         "Ваша медаль      "Заберите          опыт!"           ║
║   номером          в пути"           медаль"                             ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

### 3.2 Детальный flow страницы оплаты

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    СТРАНИЦА ОПЛАТЫ (Payment Page)                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────┐  │
│  │      ЛЕВАЯ КОЛОНКА          │  │       ПРАВАЯ КОЛОНКА            │  │
│  │      (PaymentForm)          │  │       (ChallengeInfo)           │  │
│  ├─────────────────────────────┤  ├─────────────────────────────────┤  │
│  │                             │  │                                 │  │
│  │  ┌─────────────────────┐    │  │  ┌─────────────────────────┐   │  │
│  │  │ First Name*         │    │  │  │  [Изображение медали]   │   │  │
│  │  │ ┌─────────────────┐ │    │  │  │                         │   │  │
│  │  │ │ John            │ │    │  │  │  AMAZONIA QUEST         │   │  │
│  │  │ └─────────────────┘ │    │  │  │  42 km challenge        │   │  │
│  │  └─────────────────────┘    │  │  └─────────────────────────┘   │  │
│  │                             │  │                                 │  │
│  │  ┌─────────────────────┐    │  │  ┌─────────────────────────┐   │  │
│  │  │ Last Name*          │    │  │  │     ORDER SUMMARY       │   │  │
│  │  │ ┌─────────────────┐ │    │  │  ├─────────────────────────┤   │  │
│  │  │ │ Doe             │ │    │  │  │                         │   │  │
│  │  │ └─────────────────┘ │    │  │  │  Challenge      $49.00  │   │  │
│  │  └─────────────────────┘    │  │  │                         │   │  │
│  │                             │  │  │  Shipping to    $14.99  │   │  │
│  │  ┌─────────────────────┐    │  │  │  Europe                 │   │  │
│  │  │ Email*              │    │  │  │  ─────────────────────  │   │  │
│  │  │ ┌─────────────────┐ │    │  │  │  Est. delivery:        │   │  │
│  │  │ │ john@email.com  │ │    │  │  │  5-10 business days    │   │  │
│  │  │ └─────────────────┘ │    │  │  │                         │   │  │
│  │  └─────────────────────┘    │  │  │  ═════════════════════  │   │  │
│  │                             │  │  │  TOTAL          $63.99  │   │  │
│  │  ┌─────────────────────┐    │  │  │                         │   │  │
│  │  │ Delivery Country*   │◄───┼──┼──│  [i] Shipping is        │   │  │
│  │  │ ┌─────────────────┐ │    │  │  │  calculated based on    │   │  │
│  │  │ │ Germany      ▼  │ │    │  │  │  your selected region   │   │  │
│  │  │ └─────────────────┘ │    │  │  └─────────────────────────┘   │  │
│  │  │ Where will you want │    │  │                                 │  │
│  │  │ your medal shipped? │    │  │  ┌─────────────────────────┐   │  │
│  │  └─────────────────────┘    │  │  │  [!] You can enter the  │   │  │
│  │                             │  │  │  exact address after    │   │  │
│  │  ┌─────────────────────┐    │  │  │  completing the         │   │  │
│  │  │ Promo Code          │    │  │  │  challenge              │   │  │
│  │  │ ┌─────────────────┐ │    │  │  └─────────────────────────┘   │  │
│  │  │ │                 │ │    │  │                                 │  │
│  │  │ └─────────────────┘ │    │  │                                 │  │
│  │  └─────────────────────┘    │  │                                 │  │
│  │                             │  │                                 │  │
│  │  ┌─────────────────────┐    │  │                                 │  │
│  │  │   [Proceed to Pay]  │    │  │                                 │  │
│  │  └─────────────────────┘    │  │                                 │  │
│  │                             │  │                                 │  │
│  └─────────────────────────────┘  └─────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

ВЗАИМОДЕЙСТВИЕ:
═══════════════

1. Пользователь выбирает страну в "Delivery Country"
                    │
                    ▼
2. Frontend отправляет запрос: POST /api/shipping/rate
   Body: { countryCode: "DE" }
                    │
                    ▼
3. Backend возвращает:
   {
     zoneId: "europe",
     zoneName: "Europe",
     price: 14.99,
     currency: "USD",
     estimatedDeliveryDays: { min: 5, max: 10 }
   }
                    │
                    ▼
4. Order Summary обновляется в реальном времени
                    │
                    ▼
5. При клике "Proceed to Pay" - данные отправляются в Stripe
   с ПОЛНОЙ суммой (челлендж + доставка)
```

---

## 4. Детальные flow-диаграммы

### 4.1 Процесс покупки (Purchase Flow)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PURCHASE FLOW                                   │
└─────────────────────────────────────────────────────────────────────────┘

     ┌──────────┐
     │  START   │
     └────┬─────┘
          │
          ▼
┌─────────────────────┐
│ Загрузка страницы   │
│ /payment            │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐     ┌─────────────────────┐
│ GET /api/payment/   │────►│ Redux: setProducts  │
│ products            │     │ (список челленджей) │
└─────────────────────┘     └─────────────────────┘
          │
          ▼
┌─────────────────────┐     ┌─────────────────────┐
│ GET /api/shipping/  │────►│ Redux: setZones     │
│ zones               │     │ (зоны доставки)     │
└─────────────────────┘     └─────────────────────┘
          │
          ▼
┌─────────────────────┐
│ Пользователь        │
│ выбирает челлендж   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Пользователь        │
│ выбирает страну     │◄──────────────────────┐
│ доставки            │                       │
└─────────┬───────────┘                       │
          │                                   │
          ▼                                   │
┌─────────────────────┐                       │
│ POST /api/shipping/ │                       │
│ rate                │                       │
│ { countryCode: XX } │                       │
└─────────┬───────────┘                       │
          │                                   │
          ▼                                   │
┌─────────────────────┐     ┌─────────────────┴───┐
│ Обновить UI:        │     │ Пользователь меняет │
│ - Цена доставки     │     │ страну?             │
│ - Срок доставки     │     │                     │
│ - Итоговая сумма    │     │    ДА               │
└─────────┬───────────┘     └─────────────────────┘
          │
          ▼
┌─────────────────────┐
│ Пользователь        │
│ заполняет форму:    │
│ - First Name        │
│ - Last Name         │
│ - Email             │
│ - Promo Code        │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Клик "Proceed to    │
│ Pay"                │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Валидация формы     │
└─────────┬───────────┘
          │
     ┌────┴────┐
     │ Valid?  │
     └────┬────┘
          │
    ┌─────┴─────┐
    │           │
    ▼           ▼
  [ДА]        [НЕТ]
    │           │
    │           ▼
    │    ┌─────────────────┐
    │    │ Показать ошибки │
    │    │ валидации       │
    │    └─────────────────┘
    │
    ▼
┌─────────────────────┐
│ POST /api/payment/  │
│ order               │
│ {                   │
│   stripe_price_id,  │
│   shipping_zone_id, │
│   delivery_country, │
│   shipping_price,   │
│   email,            │
│   first_name,       │
│   last_name         │
│ }                   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Backend:            │
│ 1. Создать Order    │
│ 2. Сохранить        │
│    shipping данные  │
│ 3. Создать Stripe   │
│    Checkout Session │
│    (с полной суммой)│
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Redirect на Stripe  │
│ Checkout            │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Пользователь        │
│ оплачивает          │
└─────────┬───────────┘
          │
     ┌────┴────┐
     │ Успех?  │
     └────┬────┘
          │
    ┌─────┴─────┐
    │           │
    ▼           ▼
  [ДА]        [НЕТ]
    │           │
    │           ▼
    │    ┌─────────────────┐
    │    │ Redirect на     │
    │    │ /payment?error  │
    │    └─────────────────┘
    │
    ▼
┌─────────────────────┐
│ Stripe Webhook:     │
│ payment_intent.     │
│ succeeded           │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Backend:            │
│ 1. Обновить статус  │
│    Order = paid     │
│ 2. Активировать     │
│    челлендж         │
│ 3. Отправить email  │
│    подтверждения    │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Redirect на         │
│ /payment/success    │
└─────────┬───────────┘
          │
          ▼
     ┌──────────┐
     │   END    │
     └──────────┘
```

### 4.2 Процесс получения награды (Redemption Flow)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         REDEMPTION FLOW                                 │
└─────────────────────────────────────────────────────────────────────────┘

     ┌──────────┐
     │  START   │
     │(Челлендж │
     │завершен) │
     └────┬─────┘
          │
          ▼
┌─────────────────────┐
│ Система отправляет  │
│ уведомление:        │
│ - Push notification │
│ - Email             │
│ "Заберите медаль!"  │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Пользователь        │
│ открывает           │
│ /redeem/{challengeId}│
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ GET /api/user/      │
│ challenge/{id}      │
│ (получить данные    │
│  о заказе и зоне)   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ STEP 1:             │
│ Personal Details    │
│ ─────────────────   │
│ • First Name        │
│ • Last Name         │
│ • Email             │
│ • Phone + dial code │
│ • Country           │◄─────┐
└─────────┬───────────┘      │
          │                  │
          ▼                  │
┌─────────────────────┐      │
│ Проверка: страна    │      │
│ входит в оплаченную │      │
│ зону?               │      │
└─────────┬───────────┘      │
          │                  │
    ┌─────┴─────┐            │
    │           │            │
    ▼           ▼            │
  [ДА]        [НЕТ]          │
    │           │            │
    │           ▼            │
    │    ┌─────────────────┐ │
    │    │ ПРЕДУПРЕЖДЕНИЕ: │ │
    │    │ "Выбранная      │ │
    │    │ страна не входит│ │
    │    │ в оплаченную    │ │
    │    │ зону Europe.    │ │
    │    │                 │ │
    │    │ Варианты:       │ │
    │    │ 1. Изменить     │─┘
    │    │    страну       │
    │    │ 2. Доплатить    │───────┐
    │    │    разницу      │       │
    │    └─────────────────┘       │
    │                              │
    │                              ▼
    │                   ┌─────────────────────┐
    │                   │ Процесс доплаты     │
    │                   │ (отдельный Stripe   │
    │                   │ Payment Intent)     │
    │                   └─────────┬───────────┘
    │                             │
    │◄────────────────────────────┘
    │
    ▼
┌─────────────────────┐
│ STEP 2:             │
│ Shipping Address    │
│ ─────────────────   │
│ • Address Line 1    │
│ • Address Line 2    │
│ • City              │
│ • State/Province    │
│ • ZIP/Postal Code   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ POST /api/shipping/ │
│ validate-address    │
│ (опционально:       │
│  валидация через    │
│  DHL API)           │
└─────────┬───────────┘
          │
    ┌─────┴─────┐
    │  Valid?   │
    └─────┬─────┘
          │
    ┌─────┴─────┐
    │           │
    ▼           ▼
  [ДА]        [НЕТ]
    │           │
    │           ▼
    │    ┌─────────────────┐
    │    │ Показать ошибки │
    │    │ "Адрес не найден│
    │    │ Проверьте       │
    │    │ правильность"   │
    │    └─────────────────┘
    │
    ▼
┌─────────────────────┐
│ STEP 3:             │
│ Confirmation        │
│ ─────────────────   │
│ Показать:           │
│ • Все введенные     │
│   данные            │
│ • Изображение       │
│   медали            │
│ • Ожидаемый срок    │
│   доставки          │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Клик "Claim Medal"  │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ POST /api/user/     │
│ redeem-reward       │
│ {                   │
│   challenge_id,     │
│   shipping_address, │
│   contact_info      │
│ }                   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Backend:            │
│ 1. Создать          │
│    RewardTicket     │
│ 2. Поставить в      │
│    очередь на       │
│    отправку         │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Показать:           │
│ "Ваша медаль скоро  │
│ будет отправлена!"  │
│                     │
│ Статус: CREATED     │
└─────────┬───────────┘
          │
          ▼
     ┌──────────┐
     │   END    │
     └──────────┘
```

### 4.3 Процесс отправки и отслеживания (Shipping Flow)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SHIPPING & TRACKING FLOW                             │
└─────────────────────────────────────────────────────────────────────────┘

     ┌──────────┐
     │  START   │
     │(Ticket   │
     │created)  │
     └────┬─────┘
          │
          ▼
┌─────────────────────┐
│ ВНУТРЕННИЙ ПРОЦЕСС  │
│ (Склад/Операции)    │
│ ─────────────────   │
│ 1. Проверка наличия │
│    медали на складе │
│ 2. Упаковка         │
│ 3. Печать этикетки  │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Обновить статус:    │
│ IN_PROGRESS         │
│                     │
│ Уведомить           │
│ пользователя        │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ POST DHL API:       │
│ /express/shipments  │
│ ─────────────────   │
│ Создать отправление │
│ с данными:          │
│ • Адрес отправителя │
│ • Адрес получателя  │
│ • Вес, размеры      │
│ • Тип сервиса       │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ DHL возвращает:     │
│ • Tracking Number   │
│ • Shipment ID       │
│ • Label (PDF)       │
│ • Est. delivery     │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Backend:            │
│ 1. Сохранить        │
│    tracking_number  │
│ 2. Сохранить        │
│    shipment_id      │
│ 3. Обновить статус: │
│    ON_THE_WAY       │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ Email пользователю: │
│ "Ваша медаль        │
│ отправлена!         │
│                     │
│ Tracking: XXXXXXXXX │
│ [Отследить]"        │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      ОТСЛЕЖИВАНИЕ (LOOP)                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌───────────────────┐                                                 │
│   │   CRON JOB или    │                                                 │
│   │   DHL Webhook     │                                                 │
│   │   (каждый час)    │                                                 │
│   └─────────┬─────────┘                                                 │
│             │                                                           │
│             ▼                                                           │
│   ┌───────────────────┐                                                 │
│   │ GET DHL API:      │                                                 │
│   │ /track/shipments? │                                                 │
│   │ trackingNumber=XX │                                                 │
│   └─────────┬─────────┘                                                 │
│             │                                                           │
│             ▼                                                           │
│   ┌───────────────────┐     ┌───────────────────┐                       │
│   │ Статус изменился? │─YES─►│ Обновить статус   │                       │
│   │                   │     │ в базе данных     │                       │
│   └─────────┬─────────┘     └─────────┬─────────┘                       │
│             │                         │                                 │
│            NO                         ▼                                 │
│             │               ┌───────────────────┐                       │
│             │               │ Push/Email        │                       │
│             │               │ уведомление       │                       │
│             │               │ пользователю      │                       │
│             │               └───────────────────┘                       │
│             │                                                           │
│             ▼                                                           │
│   ┌───────────────────┐                                                 │
│   │ Статус =          │                                                 │
│   │ DELIVERED?        │                                                 │
│   └─────────┬─────────┘                                                 │
│             │                                                           │
│       ┌─────┴─────┐                                                     │
│       │           │                                                     │
│       ▼           ▼                                                     │
│     [ДА]        [НЕТ]──────► Продолжить отслеживание                    │
│       │                                                                 │
│       ▼                                                                 │
│   ┌───────────────────┐                                                 │
│   │ Обновить статус:  │                                                 │
│   │ RECEIVED          │                                                 │
│   └───────────────────┘                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────┐
│ Email/Push:         │
│ "Медаль доставлена!"│
│                     │
│ [Оставить отзыв]    │
└─────────┬───────────┘
          │
          ▼
     ┌──────────┐
     │   END    │
     └──────────┘
```

---

## 5. Зоны доставки и ценообразование

### 5.1 Карта зон доставки

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ЗОНЫ ДОСТАВКИ                                    │
└─────────────────────────────────────────────────────────────────────────┘

                    ОТПРАВКА ИЗ: Германия (DE)
                    ═══════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   ЗОНА 1: EUROPE                          ЗОНА 2: NORTH AMERICA         │
│   ══════════════                          ═════════════════════         │
│                                                                         │
│   Страны:                                 Страны:                       │
│   • Германия (DE)                         • США (US)                    │
│   • Франция (FR)                          • Канада (CA)                 │
│   • Испания (ES)                                                        │
│   • Италия (IT)                           Стоимость: $14.99             │
│   • Нидерланды (NL)                       Срок: 7-14 дней               │
│   • Великобритания (GB)                                                 │
│                                                                         │
│   Стоимость: $9.99                                                      │
│   Срок: 5-10 дней                                                       │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ЗОНА 3: ASIA PACIFIC                    ЗОНА 4: CIS                   │
│   ════════════════════                    ═══════════                   │
│                                                                         │
│   Страны:                                 Страны:                       │
│   • Япония (JP)                           • Россия (RU)                 │
│   • Австралия (AU)                        • Беларусь (BY)               │
│                                           • Казахстан (KZ)              │
│   Стоимость: $19.99                       • Армения (AM)                │
│   Срок: 10-21 дней                                                      │
│                                           Стоимость: $24.99             │
│                                           Срок: 14-28 дней              │
│                                                                         │
│   * Санкции и ограничения могут влиять                                  │
│     на доступность доставки в CIS                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Структура данных зон

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PRICING MODEL                                        │
└─────────────────────────────────────────────────────────────────────────┘

SHIPPING_ZONES = [
  {
    id: "europe",
    name: "Europe",
    countries: ["DE", "FR", "ES", "IT", "NL", "GB"],
    pricing: {
      base_price: 9.99,
      currency: "USD",
      weight_limit_kg: 0.5,          // До 500г
      extra_per_kg: 5.00             // За каждый доп. кг
    },
    delivery: {
      min_days: 5,
      max_days: 10,
      service_type: "DHL_EXPRESS_WORLDWIDE"
    },
    restrictions: []
  },

  {
    id: "north-america",
    name: "North America",
    countries: ["US", "CA"],
    pricing: {
      base_price: 14.99,
      currency: "USD",
      weight_limit_kg: 0.5,
      extra_per_kg: 7.00
    },
    delivery: {
      min_days: 7,
      max_days: 14,
      service_type: "DHL_EXPRESS_WORLDWIDE"
    },
    restrictions: []
  },

  {
    id: "asia-pacific",
    name: "Asia Pacific",
    countries: ["JP", "AU"],
    pricing: {
      base_price: 19.99,
      currency: "USD",
      weight_limit_kg: 0.5,
      extra_per_kg: 10.00
    },
    delivery: {
      min_days: 10,
      max_days: 21,
      service_type: "DHL_EXPRESS_WORLDWIDE"
    },
    restrictions: []
  },

  {
    id: "cis",
    name: "CIS",
    countries: ["RU", "BY", "KZ", "AM"],
    pricing: {
      base_price: 24.99,
      currency: "USD",
      weight_limit_kg: 0.5,
      extra_per_kg: 12.00
    },
    delivery: {
      min_days: 14,
      max_days: 28,
      service_type: "DHL_EXPRESS_WORLDWIDE"
    },
    restrictions: [
      "Subject to sanctions compliance",
      "Customs clearance may cause delays"
    ]
  }
]
```

### 5.3 Расчет итоговой стоимости

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   ФОРМУЛА РАСЧЕТА СТОИМОСТИ                             │
└─────────────────────────────────────────────────────────────────────────┘

TOTAL_PRICE = CHALLENGE_PRICE + SHIPPING_PRICE + (PROMO_DISCOUNT)

Где:
────

CHALLENGE_PRICE = Цена челленджа из Stripe Price ID
                  Пример: $49.00

SHIPPING_PRICE  = zone.base_price +
                  MAX(0, (package_weight - weight_limit_kg)) * extra_per_kg

                  Пример для Europe, медаль 300г:
                  $9.99 + MAX(0, (0.3 - 0.5)) * $5 = $9.99 + 0 = $9.99

PROMO_DISCOUNT  = Если есть промокод:
                  - Процент: -X% от CHALLENGE_PRICE
                  - Фиксированная сумма: -$X
                  - Бесплатная доставка: SHIPPING_PRICE = 0

═══════════════════════════════════════════════════════════════════════════

ПРИМЕРЫ:
────────

┌─────────────────────────────────────────────────────────────────────────┐
│ ПРИМЕР 1: Европа, без промокода                                         │
├─────────────────────────────────────────────────────────────────────────┤
│ Challenge (Amazonia Quest 42km)     $49.00                              │
│ Shipping to Europe                   $9.99                              │
│ ─────────────────────────────────────────                               │
│ TOTAL                               $58.99                              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ПРИМЕР 2: США, промокод 10%                                             │
├─────────────────────────────────────────────────────────────────────────┤
│ Challenge (Amazonia Quest 42km)     $49.00                              │
│ Promo code SAVE10 (-10%)            -$4.90                              │
│ Shipping to North America           $14.99                              │
│ ─────────────────────────────────────────                               │
│ TOTAL                               $59.09                              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ПРИМЕР 3: Россия, промокод FREESHIP                                     │
├─────────────────────────────────────────────────────────────────────────┤
│ Challenge (Amazonia Quest 42km)     $49.00                              │
│ Shipping to CIS                     $24.99                              │
│ Promo code FREESHIP                -$24.99                              │
│ ─────────────────────────────────────────                               │
│ TOTAL                               $49.00                              │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Взаимодействие систем

### 6.1 Архитектура интеграции

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SYSTEMS INTEGRATION ARCHITECTURE                     │
└─────────────────────────────────────────────────────────────────────────┘


                              ┌─────────────────┐
                              │                 │
                              │   ПОЛЬЗОВАТЕЛЬ  │
                              │                 │
                              └────────┬────────┘
                                       │
                                       │ HTTPS
                                       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│                         FRONTEND (Next.js)                              │
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  Payment    │  │  Redemption │  │  Tracking   │  │   Profile   │    │
│  │  Page       │  │  Pages      │  │  Page       │  │   Page      │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
│         │                │                │                │            │
│         └────────────────┴────────────────┴────────────────┘            │
│                                   │                                     │
│                            Redux Store                                  │
│                     (products, shipping, user)                          │
│                                                                         │
└─────────────────────────────────────┬───────────────────────────────────┘
                                      │
                                      │ API Routes
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│                      NEXT.JS API ROUTES                                 │
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │ /api/payment/*  │  │ /api/shipping/* │  │ /api/user/*     │         │
│  │                 │  │                 │  │                 │         │
│  │ • products      │  │ • zones         │  │ • redeem-reward │         │
│  │ • order         │  │ • rate          │  │ • challenge     │         │
│  │ • webhook       │  │ • validate      │  │ • profile       │         │
│  │                 │  │ • track         │  │                 │         │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘         │
│           │                    │                    │                   │
└───────────┼────────────────────┼────────────────────┼───────────────────┘
            │                    │                    │
            ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│                      BACKEND API (dev.myfinishline.io)                  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         Core Services                            │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │   │
│  │  │ Order        │  │ Shipping     │  │ User         │           │   │
│  │  │ Service      │  │ Service      │  │ Service      │           │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         Database                                 │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │   │
│  │  │ Orders   │  │ Users    │  │ Rewards  │  │ Shipments│         │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└──────────────┬────────────────────────────────────┬─────────────────────┘
               │                                    │
               │                                    │
               ▼                                    ▼
┌──────────────────────────┐          ┌──────────────────────────┐
│                          │          │                          │
│      STRIPE API          │          │       DHL API            │
│                          │          │                          │
│  • Checkout Sessions     │          │  • Rating (цены)         │
│  • Payment Intents       │          │  • Shipments (создание)  │
│  • Webhooks              │          │  • Tracking (статус)     │
│  • Customers             │          │  • Location Finder       │
│  • Prices/Products       │          │                          │
│                          │          │                          │
└──────────────────────────┘          └──────────────────────────┘

```

### 6.2 Sequence Diagram: Покупка с доставкой

```
┌─────────────────────────────────────────────────────────────────────────┐
│              SEQUENCE DIAGRAM: PURCHASE WITH SHIPPING                   │
└─────────────────────────────────────────────────────────────────────────┘

┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐
│Browser │     │Next.js │     │Backend │     │ Stripe │     │  DHL   │
│        │     │  API   │     │  API   │     │        │     │  API   │
└───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘
    │              │              │              │              │
    │ GET /payment │              │              │              │
    │─────────────►│              │              │              │
    │              │              │              │              │
    │              │ GET /products│              │              │
    │              │─────────────►│              │              │
    │              │◄─────────────│              │              │
    │              │   products   │              │              │
    │              │              │              │              │
    │◄─────────────│              │              │              │
    │  Render page │              │              │              │
    │              │              │              │              │
    │ GET /shipping/zones         │              │              │
    │─────────────►│              │              │              │
    │              │ GET /zones   │              │              │
    │              │─────────────►│              │              │
    │              │◄─────────────│              │              │
    │◄─────────────│    zones     │              │              │
    │              │              │              │              │
    │──────────────────────────────────────────────────────────│
    │         User selects country: "Germany"                  │
    │──────────────────────────────────────────────────────────│
    │              │              │              │              │
    │ POST /shipping/rate         │              │              │
    │ {countryCode:"DE"}          │              │              │
    │─────────────►│              │              │              │
    │              │ Calculate    │              │              │
    │              │ rate         │              │              │
    │              │─────────────►│              │              │
    │              │              │              │              │
    │              │   [Optional: Query DHL for exact rate]    │
    │              │              │──────────────────────────►│
    │              │              │◄──────────────────────────│
    │              │              │              │              │
    │              │◄─────────────│              │              │
    │◄─────────────│ {price:9.99} │              │              │
    │              │              │              │              │
    │──────────────────────────────────────────────────────────│
    │      UI updates: Total = $49 + $9.99 = $58.99            │
    │──────────────────────────────────────────────────────────│
    │              │              │              │              │
    │ User fills form and clicks "Pay"                         │
    │              │              │              │              │
    │ POST /payment/order         │              │              │
    │ {stripe_price_id,           │              │              │
    │  shipping_zone_id,          │              │              │
    │  delivery_country,          │              │              │
    │  shipping_price}            │              │              │
    │─────────────►│              │              │              │
    │              │              │              │              │
    │              │ POST /order  │              │              │
    │              │─────────────►│              │              │
    │              │              │              │              │
    │              │              │ Create Checkout Session     │
    │              │              │ (challenge_price +          │
    │              │              │  shipping_price)            │
    │              │              │─────────────►│              │
    │              │              │◄─────────────│              │
    │              │              │ session_url  │              │
    │              │◄─────────────│              │              │
    │◄─────────────│ payment_url  │              │              │
    │              │              │              │              │
    │ Redirect to Stripe Checkout │              │              │
    │─────────────────────────────────────────►│              │
    │              │              │              │              │
    │──────────────────────────────────────────────────────────│
    │                 User completes payment                   │
    │──────────────────────────────────────────────────────────│
    │              │              │              │              │
    │              │              │   Webhook:   │              │
    │              │              │   payment_   │              │
    │              │              │   succeeded  │              │
    │              │              │◄─────────────│              │
    │              │              │              │              │
    │              │              │ Update order │              │
    │              │              │ status=paid  │              │
    │              │              │              │              │
    │◄─────────────────────────────────────────│              │
    │ Redirect to /payment/success             │              │
    │              │              │              │              │
    ▼              ▼              ▼              ▼              ▼
```

### 6.3 Sequence Diagram: Redemption и отправка

```
┌─────────────────────────────────────────────────────────────────────────┐
│              SEQUENCE DIAGRAM: REDEMPTION & SHIPPING                    │
└─────────────────────────────────────────────────────────────────────────┘

┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐
│Browser │     │Next.js │     │Backend │     │  DHL   │     │ Email  │
│        │     │  API   │     │  API   │     │  API   │     │Service │
└───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘
    │              │              │              │              │
    │──────────────────────────────────────────────────────────│
    │     Challenge completed - User clicks "Claim Medal"      │
    │──────────────────────────────────────────────────────────│
    │              │              │              │              │
    │ GET /redeem/{challengeId}   │              │              │
    │─────────────►│              │              │              │
    │              │ GET /challenge/{id}         │              │
    │              │─────────────►│              │              │
    │              │◄─────────────│              │              │
    │◄─────────────│ challenge +  │              │              │
    │              │ shipping_zone│              │              │
    │              │              │              │              │
    │──────────────────────────────────────────────────────────│
    │  User enters address (must match paid shipping zone)     │
    │──────────────────────────────────────────────────────────│
    │              │              │              │              │
    │ POST /shipping/validate-address            │              │
    │ {address, city, country...} │              │              │
    │─────────────►│              │              │              │
    │              │ Validate     │              │              │
    │              │─────────────►│              │              │
    │              │              │ Address      │              │
    │              │              │ Validation   │              │
    │              │              │─────────────►│              │
    │              │              │◄─────────────│              │
    │              │◄─────────────│ valid/invalid│              │
    │◄─────────────│              │              │              │
    │              │              │              │              │
    │──────────────────────────────────────────────────────────│
    │  User confirms - clicks "Claim Medal"                    │
    │──────────────────────────────────────────────────────────│
    │              │              │              │              │
    │ POST /user/redeem-reward    │              │              │
    │ {challenge_id, address...}  │              │              │
    │─────────────►│              │              │              │
    │              │ POST /redeem │              │              │
    │              │─────────────►│              │              │
    │              │              │              │              │
    │              │              │ Create       │              │
    │              │              │ RewardTicket │              │
    │              │              │ status=      │              │
    │              │              │ CREATED      │              │
    │              │              │              │              │
    │              │◄─────────────│              │              │
    │◄─────────────│   success    │              │              │
    │              │              │              │              │
    │──────────────────────────────────────────────────────────│
    │              WAREHOUSE PROCESSING (async)                │
    │──────────────────────────────────────────────────────────│
    │              │              │              │              │
    │              │              │ Pack medal,  │              │
    │              │              │ update status│              │
    │              │              │ IN_PROGRESS  │              │
    │              │              │              │              │
    │              │              │ POST         │              │
    │              │              │ /shipments   │              │
    │              │              │─────────────►│              │
    │              │              │◄─────────────│              │
    │              │              │ tracking_num │              │
    │              │              │ label_pdf    │              │
    │              │              │              │              │
    │              │              │ Update status│              │
    │              │              │ ON_THE_WAY   │              │
    │              │              │              │              │
    │              │              │ Send email   │              │
    │              │              │─────────────────────────►│
    │              │              │              │              │
    │◄─────────────────────────────────────────────────────────│
    │    Email: "Your medal is on the way! Track: XXXXXXX"     │
    │              │              │              │              │
    │──────────────────────────────────────────────────────────│
    │                    TRACKING LOOP                         │
    │──────────────────────────────────────────────────────────│
    │              │              │              │              │
    │              │              │ CRON/Webhook │              │
    │              │              │ GET /track   │              │
    │              │              │─────────────►│              │
    │              │              │◄─────────────│              │
    │              │              │ status_update│              │
    │              │              │              │              │
    │              │              │ If status    │              │
    │              │              │ changed:     │              │
    │              │              │ notify user  │              │
    │              │              │─────────────────────────►│
    │◄─────────────────────────────────────────────────────────│
    │              │              │              │              │
    │──────────────────────────────────────────────────────────│
    │  When status = DELIVERED: mark as RECEIVED               │
    │──────────────────────────────────────────────────────────│
    │              │              │              │              │
    ▼              ▼              ▼              ▼              ▼
```

---

## 7. Сценарии и Edge Cases

### 7.1 Основные сценарии

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ОСНОВНЫЕ СЦЕНАРИИ ИСПОЛЬЗОВАНИЯ                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ СЦЕНАРИЙ 1: Стандартная покупка и получение                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ Условия:                                                                │
│ • Пользователь из Германии                                              │
│ • Выбирает Германию как страну доставки                                 │
│ • Проходит челлендж успешно                                             │
│ • Вводит адрес в Германии                                               │
│                                                                         │
│ Результат:                                                              │
│ ✓ Оплата: $49 + $9.99 = $58.99                                          │
│ ✓ Доставка: 5-10 дней                                                   │
│ ✓ Без дополнительных действий                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ СЦЕНАРИЙ 2: Пользователь с VPN                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ Условия:                                                                │
│ • IP показывает США (VPN)                                               │
│ • Реально находится в России                                            │
│ • Хочет доставку в Россию                                               │
│                                                                         │
│ Действия пользователя:                                                  │
│ 1. Выбирает "Russia" в поле Delivery Country                            │
│ 2. Видит стоимость доставки CIS: $24.99                                 │
│ 3. Оплачивает: $49 + $24.99 = $73.99                                    │
│                                                                         │
│ Результат:                                                              │
│ ✓ Система не полагается на IP                                           │
│ ✓ Пользователь сам выбрал корректный регион                             │
│ ✓ При redemption адрес валидируется против оплаченной зоны              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ СЦЕНАРИЙ 3: Смена страны при redemption                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ Условия:                                                                │
│ • Оплачена доставка в Europe (Германия)                                 │
│ • При redemption хочет доставку в США                                   │
│                                                                         │
│ Система:                                                                │
│ 1. Обнаруживает несоответствие зоны                                     │
│ 2. Показывает сообщение:                                                │
│    "Вы оплатили доставку в Europe ($9.99).                              │
│     Доставка в USA стоит $14.99.                                        │
│     Разница: $5.00"                                                     │
│                                                                         │
│ Варианты:                                                               │
│ A) Изменить страну на входящую в Europe                                 │
│ B) Доплатить $5.00                                                      │
│                                                                         │
│ При выборе B:                                                           │
│ • Создается дополнительный Payment Intent на $5.00                      │
│ • После оплаты - разрешается продолжить                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Edge Cases

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           EDGE CASES                                    │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ EDGE CASE 1: Страна не поддерживается                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ Ситуация: Пользователь хочет доставку в страну вне списка               │
│           (например, Бразилия)                                          │
│                                                                         │
│ Решение:                                                                │
│ • Показать сообщение: "Доставка в выбранную страну                      │
│   временно недоступна"                                                  │
│ • Предложить: "Свяжитесь с поддержкой для                               │
│   индивидуального расчета"                                              │
│ • Альтернатива: Добавить зону "Rest of World"                           │
│   с фиксированной высокой ценой                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ EDGE CASE 2: DHL не доставляет в регион (санкции)                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ Ситуация: DHL временно не доставляет в некоторые страны CIS             │
│                                                                         │
│ Решение:                                                                │
│ 1. Проверять доступность через DHL API при выборе страны                │
│ 2. Если недоступно - показать уведомление                               │
│ 3. Предложить альтернативные службы доставки                            │
│    (если интегрированы)                                                 │
│ 4. Или: "Доставка временно недоступна. Оставьте email -                 │
│    мы уведомим когда станет возможной"                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ EDGE CASE 3: Истек срок redemption                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ Ситуация: Прошло 12 месяцев после завершения челленджа                  │
│                                                                         │
│ Решение:                                                                │
│ • За 30 дней до истечения - напоминание по email                        │
│ • За 7 дней - повторное напоминание                                     │
│ • После истечения:                                                      │
│   - Награда аннулируется                                                │
│   - Возврат стоимости доставки (опционально)                            │
│   - Показать: "Срок получения награды истек"                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ EDGE CASE 4: Посылка потеряна/повреждена                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ Ситуация: DHL сообщает о потере или повреждении                         │
│                                                                         │
│ Решение:                                                                │
│ 1. Автоматическое уведомление администратора                            │
│ 2. Email пользователю: "Возникла проблема с доставкой"                  │
│ 3. Создать claim в DHL                                                  │
│ 4. Варианты для пользователя:                                           │
│    - Повторная отправка (бесплатно)                                     │
│    - Полный возврат средств                                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ EDGE CASE 5: Ошибка адреса / Недоставленная посылка                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ Ситуация: Посылка вернулась отправителю из-за неверного адреса          │
│                                                                         │
│ Решение:                                                                │
│ 1. Уведомить пользователя: "Посылка не доставлена -                     │
│    проверьте адрес"                                                     │
│ 2. Дать возможность исправить адрес                                     │
│ 3. Повторная отправка:                                                  │
│    - Если ошибка пользователя: за доп. плату                            │
│    - Если наша ошибка: бесплатно                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ EDGE CASE 6: Отмена заказа до redemption                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ Ситуация: Пользователь хочет отменить после оплаты,                     │
│           но до отправки                                                │
│                                                                         │
│ Решение:                                                                │
│ Политика возврата:                                                      │
│ • До завершения челленджа: полный возврат                               │
│   (challenge + shipping)                                                │
│ • После завершения, до redemption: частичный возврат                    │
│   (только shipping)                                                     │
│ • После создания shipment: возврат невозможен                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ EDGE CASE 7: Промокод на бесплатную доставку                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ Ситуация: Промокод дает 100% скидку на доставку                         │
│                                                                         │
│ Решение:                                                                │
│ 1. Пользователь все равно должен выбрать страну доставки                │
│ 2. Показать: "Shipping: $14.99 → $0.00 (FREESHIP applied)"              │
│ 3. Зона сохраняется в заказе для валидации при redemption               │
│ 4. При смене зоны на более дорогую:                                     │
│    - Взимать полную разницу (а не от $0)                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Статусы и уведомления

### 8.1 Жизненный цикл заказа

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ORDER & SHIPMENT LIFECYCLE                           │
└─────────────────────────────────────────────────────────────────────────┘

                    ORDER STATUSES
                    ══════════════

┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ PENDING  │───►│  PAID    │───►│ ACTIVE   │───►│COMPLETED │
│          │    │          │    │          │    │          │
│ Ожидает  │    │ Оплачен  │    │ Челлендж │    │ Челлендж │
│ оплаты   │    │          │    │ активен  │    │ завершен │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
     │                              │
     │                              │
     ▼                              ▼
┌──────────┐                  ┌──────────┐
│ CANCELLED│                  │ EXPIRED  │
│          │                  │          │
│ Отменен  │                  │ Истек    │
│          │                  │ срок     │
└──────────┘                  └──────────┘


                    SHIPMENT STATUSES
                    ═════════════════

┌──────────┐    ┌───────────┐    ┌───────────┐
│ CREATED  │───►│IN_PROGRESS│───►│ON_THE_WAY │
│          │    │           │    │           │
│ Заявка   │    │ Готовится │    │ В пути    │
│ создана  │    │ к отправке│    │           │
└──────────┘    └───────────┘    └───────────┘
                                      │
                     ┌────────────────┼────────────────┐
                     │                │                │
                     ▼                ▼                ▼
              ┌───────────┐    ┌───────────┐    ┌───────────┐
              │AT_PICKUP  │    │ DELIVERED │    │  RETURNED │
              │_POINT     │    │           │    │           │
              │           │    │           │    │ Возвращена│
              │ В пункте  │    │ Доставлена│    │ отправи-  │
              │ выдачи    │    │           │    │ телю      │
              └───────────┘    └───────────┘    └───────────┘
                     │                │
                     │                │
                     ▼                ▼
              ┌───────────┐    ┌───────────┐
              │ RECEIVED  │    │   LOST    │
              │           │    │           │
              │ Получена  │    │ Потеряна  │
              │ клиентом  │    │           │
              └───────────┘    └───────────┘
```

### 8.2 Матрица уведомлений

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    NOTIFICATION MATRIX                                  │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────┬──────────┬──────────┬──────────────────────────────┐
│ Событие          │ Email    │ Push     │ Сообщение                    │
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ Order Created    │    ✓     │    -     │ "Спасибо за покупку!         │
│                  │          │          │  Начните свой челлендж"      │
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ Challenge        │    ✓     │    ✓     │ "Поздравляем! Вы завершили   │
│ Completed        │          │          │  челлендж. Заберите медаль!" │
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ Redemption       │    ✓     │    -     │ "Заявка на медаль принята.   │
│ Submitted        │          │          │  Мы готовим её к отправке"   │
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ Shipment         │    ✓     │    ✓     │ "Ваша медаль отправлена!     │
│ Created          │          │          │  Tracking: XXXXXXXXXX"       │
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ In Transit       │    -     │    ✓     │ "Медаль в пути. Ожидаемая    │
│                  │          │          │  доставка: DD.MM.YYYY"       │
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ Out for          │    -     │    ✓     │ "Медаль будет доставлена     │
│ Delivery         │          │          │  сегодня!"                   │
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ At Pickup        │    ✓     │    ✓     │ "Медаль ждет вас в пункте    │
│ Point            │          │          │  выдачи: [адрес]"            │
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ Delivered        │    ✓     │    ✓     │ "Медаль доставлена!          │
│                  │          │          │  Поделитесь фото в соцсетях" │
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ Delivery         │    ✓     │    ✓     │ "Возникла проблема с         │
│ Exception        │          │          │  доставкой. Свяжитесь с нами"│
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ Redemption       │    ✓     │    -     │ "Осталось 30 дней чтобы      │
│ Reminder (30d)   │          │          │  забрать медаль!"            │
├──────────────────┼──────────┼──────────┼──────────────────────────────┤
│ Redemption       │    ✓     │    ✓     │ "Осталось 7 дней! Не упустите│
│ Reminder (7d)    │          │          │  свою награду"               │
└──────────────────┴──────────┴──────────┴──────────────────────────────┘
```

### 8.3 Email Templates

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    EMAIL TEMPLATE: SHIPMENT CREATED                     │
└─────────────────────────────────────────────────────────────────────────┘

Subject: 🎖️ Your Amazonia Quest medal is on its way!

─────────────────────────────────────────────────────────────────────────

                         [MyFinishLine Logo]

   Hi {first_name},

   Great news! Your medal is on its way to you!

   ┌─────────────────────────────────────────────────────────────────┐
   │                                                                 │
   │   📦 SHIPMENT DETAILS                                           │
   │   ─────────────────────                                         │
   │                                                                 │
   │   Challenge:     Amazonia Quest 42km                            │
   │   Tracking #:    1234567890                                     │
   │   Carrier:       DHL Express                                    │
   │   Est. Delivery: January 30 - February 5, 2026                  │
   │                                                                 │
   │                    [TRACK YOUR SHIPMENT]                        │
   │                                                                 │
   └─────────────────────────────────────────────────────────────────┘

   ┌─────────────────────────────────────────────────────────────────┐
   │                                                                 │
   │   📍 SHIPPING TO                                                │
   │   ─────────────────                                             │
   │                                                                 │
   │   {first_name} {last_name}                                      │
   │   {address_line_1}                                              │
   │   {city}, {state} {zip_code}                                    │
   │   {country}                                                     │
   │                                                                 │
   └─────────────────────────────────────────────────────────────────┘

   Questions? Contact us at support@myfinishline.io

   Happy running! 🏃‍♂️

   — The MyFinishLine Team

─────────────────────────────────────────────────────────────────────────
```

---

## Заключение

Данный документ описывает полную бизнес-логику интеграции службы доставки DHL в систему MyFinishLine. Ключевые принципы:

1. **Пользователь контролирует выбор региона** — никакого автоопределения по IP
2. **Прозрачное ценообразование** — полная стоимость показывается ДО оплаты
3. **Двухэтапный процесс** — оплата с выбором зоны, затем точный адрес при redemption
4. **Гибкость** — поддержка смены региона с доплатой
5. **Полное отслеживание** — от создания заказа до получения медали

---

*Документ создан: 2026-01-27*
*Версия: 1.0*
